<!DOCTYPE html>
<html lang="en"><head>
 <meta charset="utf-8">
  <title>Yixue Wang is Me!</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/assets/favicon.png" ></link>
  <script src="/assets/javascript/bootstrap/jquery.min.js"></script>
  <script src="/assets/javascript/bootstrap/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" rel="author" href="/">
      <img src="/assets/favicon.png" height="35px" style="margin-right: 10px;">
      Yixue Wang
    </a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto"><li class="nav-item">
          <a class="nav-link" href="/#experiences">Experiences</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/#researches">Researches</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/articles">Articles</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/gallery"> Art Gallery</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<div class="py-1">
      <div class="container page-content">
          <h4>
    Blog
</h4>

<h1>
    AWS Parameter Store Example
</h1>
<p class="text-info">5 May, 2020</p>
 <span class="badge badge-primary">python</span> <span class="badge badge-primary">AWS</span> <span class="badge badge-primary">Lambda</span> <span class="badge badge-primary">serverless</span>
<hr>
<br>
<div class="post_content">
    <div class="bg" style="background-image: url('/assets/social_icons/AWS-Systems-Manager_Documents_dark-bg.svg');"></div>
    <h2 id="the-story-begins-from-">The Story Begins from ‚Ä¶</h2>
<p>Recently, I am working on a for-fun project with my friend Pusheenüê±. I am working on the backend using <strong>AWS Lambda</strong> functions for the backend, <strong>AWS DynamoDB</strong> as database, and <strong>Algolia</strong> for searching items. <del>Pusheen is working the frontend with React and deployed as <strong>AWS S3 Static Page</strong>.</del> We have a search function that is triggered by HTTP GET request, takes <code class="language-plaintext highlighter-rouge">keyword</code> from the parameters, and perform searching by keywords in our <strong>Algolia items</strong>.</p>

<p>For easier development and deployment, we are using <strong>AWS Serverless Application Model (AWS SAM)</strong> and <strong>PyCharm</strong> to develop locally and deploy to the <strong>AWS Cloudformation</strong>.</p>

<p>The difficulty we met here, was to find a safe place to save the <strong>Algolia API Key</strong> and <strong>Algolia API Secret</strong>. Since we plan to make the code public, saving it explicitly in the code or saving it in the cloudformation template <code class="language-plaintext highlighter-rouge">template.yaml</code> sounds dangerous.</p>

<h2 id="setup-and-use-aws-parameter-store">Setup and Use AWS Parameter Store</h2>
<p><strong>1. Create secure parameters on AWS Systems Manager.</strong></p>

<p>Firstly, we need to navigate to <strong>AWS System Manager &gt; Parameter Store</strong>.</p>
<figure>
  <img src="/assets/img/parameter_store/step1.png" alt="Step 1" />
  <figcaption> 1.1 Go to System Manager </figcaption>
</figure>
<figure>
  <img src="/assets/img/parameter_store/step2.png" alt="Step 2" />
  <figcaption> 1.2 Navigate to Parameter Store</figcaption>
</figure>

<p><strong>2. Setup the <code class="language-plaintext highlighter-rouge">template.yaml</code> for correct permissions.</strong></p>

<p><strong>3. Update the lambda function to use the parameters.</strong></p>

<h2 id="why-parameter-storage-so-important--old-versions">Why Parameter Storage So Important &amp; Old Versions</h2>
<p>The fact is, we didn‚Äôt achieve the current solution in a single effort. It tooks us 2 ugly tries until the current version.</p>
<h3 id="ugly-solution-0">Ugly Solution 0</h3>
<p>This is the initial version without any optimization: <strong>having the secrets in the lambda function as variables</strong>. This is not elegant and risky that we need to <del>manually</del> remove the secret values and we may forget to hide the keys and secrets when we commit to the online repository.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'queryStringParameters'</span><span class="p">]</span>

    <span class="n">algolia_application_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">application_id</span><span class="o">&gt;</span>
    <span class="n">algolia_search_only_key</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">search_only_key</span><span class="o">&gt;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">SearchClient</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">algolia_application_id</span><span class="p">,</span> <span class="n">algolia_search_only_key</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">init_index</span><span class="p">(</span><span class="s">'Tags'</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s">'keyword'</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>
<h3 id="still-ugly-solution-1">Still Ugly Solution 1</h3>
<p>An alternative solution is to add the secrets to the <strong>environ variables</strong>. In this way, the secrets are no longer explicitly in the lambda source code, and are moved to the <code class="language-plaintext highlighter-rouge">template.yaml</code>.
Here is our first version of vulnerable code that we include the <strong>Algolia API Secrets</strong> explicitly in the <strong>Cloudformation Template</strong> <code class="language-plaintext highlighter-rouge">template.yaml</code>, which create an <strong>API</strong> called <code class="language-plaintext highlighter-rouge">ExampleApi</code>, and an <strong>AWS Lambda</strong> function in <code class="language-plaintext highlighter-rouge">Python3.6</code> called <code class="language-plaintext highlighter-rouge">SearchFunction</code> that allows access to function execution and DynamoDB:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Resources</span><span class="pi">:</span>
  <span class="na">ExampleApi</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::Api</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">StageName</span><span class="pi">:</span> <span class="s">Staging</span>
      <span class="na">Cors</span><span class="pi">:</span>
        <span class="na">AllowOrigin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">'*'"</span>
        <span class="na">AllowMethods</span><span class="pi">:</span> <span class="s2">"</span><span class="s">'OPTIONS,HEAD,GET,PUT,POST'"</span>
        <span class="na">AllowHeaders</span><span class="pi">:</span> <span class="s2">"</span><span class="s">'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"</span>
  <span class="na">SearchFunction</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::Function</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Environment</span><span class="pi">:</span>
        <span class="na">Variables</span><span class="pi">:</span>
          <span class="na">Algolia_Application_ID</span><span class="pi">:</span> <span class="s">this_is_secrete</span>
          <span class="na">Algolia_Search_Only_Key</span><span class="pi">:</span> <span class="s">this_is_also_secrete</span>
      <span class="na">Policies</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">AWSLambdaExecute</span>
        <span class="pi">-</span> <span class="s">AmazonDynamoDBFullAccess</span>
      <span class="na">CodeUri</span><span class="pi">:</span> <span class="s">search/</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">app.lambda_handler</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s">python3.6</span>
      <span class="na">Events</span><span class="pi">:</span>
        <span class="na">Search</span><span class="pi">:</span>
          <span class="na">Type</span><span class="pi">:</span> <span class="s">Api</span> <span class="c1"># More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api</span>
          <span class="na">Properties</span><span class="pi">:</span>
            <span class="na">Path</span><span class="pi">:</span> <span class="s">/search</span>
            <span class="na">Method</span><span class="pi">:</span> <span class="s">get</span>
            <span class="na">RestApiId</span><span class="pi">:</span>
              <span class="na">Ref</span><span class="pi">:</span> <span class="s">ExampleApi</span>
</code></pre></div></div>
<p>and in the lambda function, we get the Algolia API secrets from the environment:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">algolia_application_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'Algolia_Application_ID'</span><span class="p">]</span>
<span class="n">algolia_search_only_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'Algolia_Search_Only_Key'</span><span class="p">]</span>
</code></pre></div></div>

<p>However, this version of code is still facing the same problem as the Solution 0 when publishing the code. The vulnerabilities made us move to using the Parameter Store.</p>

</div>

<style>
    .post_content {
        position: relative;
        z-index: 1;
        min-height: 200px;
    }
    .post_content .bg {
        position: absolute;
        z-index: -1;
        opacity: .1;
        width: 100%;
        height: 100%; 
        /* background-size: cover; */
        min-height: 200px;
    }
    figure figcaption {
        text-align: center;
        font-weight: bold;
        font-size: x-large;
    }
</style>


<!-- <a href="" class='btn btn-danger'>üëâBack to Home</a> -->
      </div>
    </div>
<div class="py-5 border-top">
  <div class="container">

    <p class="h5 mb-3">Yixue Wang</p>

    <div class="row">

      <div class="col-sm">
        <ul class="list-unstyled">
          <!-- <li>
            <p>Woomy&lt;:=</p>Yixue Wang</li> --><li>
              <a href="mailto:ywang20@wpi.edu">
                ywang20@wpi.edu
              </a>
            </li></ul>
      </div>


      <div class="col-sm text-right">
        <!-- <p>Woomy&lt;:=</p> -->
        <a href="https://www.linkedin.com/in/yixue-w-90818b152/" target="_blank">
          <img src="/assets/social_icons/linkedin.svg" alt="LinkedIn" width="30" height="30">
        </a>
        <a href="https://www.instagram.com/w_n_r1662/" target="_blank">
          <img src="/assets/social_icons/instagram.svg" alt="LinkedIn" width="30" height="30">
        </a>
        <a href="https://www.facebook.com/yixue.wang.794/" target="_blank">
          <img src="/assets/social_icons/facebook.svg" alt="LinkedIn" width="30" height="30">
        </a>
        <!-- https://simpleicons.org/ -->

      </div>
      <!-- https://bootswatch.com/minty/ -->

    </div>

  </div>
</div>
</body>

</html>